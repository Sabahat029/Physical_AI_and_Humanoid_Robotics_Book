import {
  InnerValue,
  RawValueSignature,
  ResolvableValueLevelAlias,
  UnresolvableModeLevelAlias,
  UnresolvableValueLevelAlias,
  ResolvedDeepStatefulValueForMode,
} from '@specifyapp/specify-design-token-format';
import type { options } from '../updateToken.js';
import { getDimensionUpdateValue, getDimensionUpdateValueOrUpdateAlias } from './dimension.js';
import { ParserToolbox } from '../../../../parsersEngine/ParserToolbox.js';

export function getRadiiUpdateValueOrUpdateAlias(
  radii: InnerValue<
    ResolvableValueLevelAlias | UnresolvableValueLevelAlias | RawValueSignature<'radii'> | null
  >,
  options: options,
  toolbox: ParserToolbox,
) {
  return radii
    .mapPrimitiveValue(v => (!!v ? getRadiiUpdateValue(v, options, toolbox) : undefined))
    .mapUnresolvableValueLevelAlias(_ => undefined)
    .mapResolvableValueLevelAlias(alias => {
      const { tokenState, targetMode, value } = alias.tokenState.resolveDeepStatefulValueForMode(
        alias.targetMode,
      ) as ResolvedDeepStatefulValueForMode<'radii'>;

      if (value instanceof UnresolvableModeLevelAlias)
        throw new Error('Unreachable as token resolvability is checked before');

      const updateValue = getRadiiUpdateValue(value, options, toolbox);

      // @ts-expect-error: Array<radii> !== [radii, radii, radii, radii]
      tokenState.updateModeValue(targetMode, updateValue);

      return undefined;
    })
    .unwrap();
}

export function getRadiiUpdateValue(
  radii: RawValueSignature<'radii'>,
  options: options,
  toolbox: ParserToolbox,
) {
  return radii.map(innerValue =>
    innerValue
      .mapPrimitiveValue(v => getDimensionUpdateValue(v, options, toolbox))
      .mapUnresolvableValueLevelAlias(_ => {
        throw new Error('Unreachable as token resolvability is checked before');
      })
      .mapResolvableValueLevelAlias(alias => {
        // We update the alias, and we return the format expected by the SDTF to update the token
        getDimensionUpdateValueOrUpdateAlias(innerValue, options, toolbox);

        return { $alias: alias.tokenState.path.toString(), $mode: alias.targetMode };
      })
      .unwrap(),
  );
}
