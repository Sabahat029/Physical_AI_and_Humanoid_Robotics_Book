import { fetch } from 'cross-fetch';

import { HttpSuccessResponseBody } from '../../index.js';
import { formatRequestHeaders } from './formatRequestHeaders.js';
import { makeSpecifyHttpApiRoute } from './makeSpecifyHttpApiRoute.js';
import { wrapFetchCall } from './wrapFetchCall.js';

/**
 * Creates a fetch client to consume data from the Specify HTTP Public API.
 * @internal
 * @param personalAccessToken
 */
export function createFetchClient(personalAccessToken: string | undefined) {
  const headers = formatRequestHeaders(personalAccessToken);

  return {
    get: async <T>({ path }: { path: string }) =>
      wrapFetchCall<HttpSuccessResponseBody<T>>(
        fetch(makeSpecifyHttpApiRoute(path), {
          method: 'GET',
          headers: headers,
        }),
      ),
    post: async <T>({ path, body }: { path: string; body: any }) =>
      wrapFetchCall<HttpSuccessResponseBody<T>>(
        fetch(makeSpecifyHttpApiRoute(path), {
          method: 'POST',
          body: JSON.stringify(body),
          headers: headers,
        }),
      ),
  };
}
