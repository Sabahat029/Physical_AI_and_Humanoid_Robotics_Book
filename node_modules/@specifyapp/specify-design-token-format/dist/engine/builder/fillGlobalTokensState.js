import { createTokenState } from './createTokenState.js';
import { SDTFError } from '../../errors/index.js';
import { findOrRegisterTokenState } from './findOrRegisterTokenState.js';
import { fillAliasReferences } from './fillAliasReferences.js';
export function fillGlobalTokensState(analyzedTokens, globalTokensState, aliasReferences, treeState) {
    analyzedTokens.all.forEach(analyzedToken => {
        let tokenState;
        // Token is not already registered because of another token aliasing it
        if (globalTokensState.has(analyzedToken.path.toString()) === false) {
            tokenState = createTokenState(treeState, analyzedToken);
            globalTokensState.add(tokenState);
        }
        else {
            const maybeTokenState = globalTokensState.getOne(analyzedToken.path.toString());
            /* v8 ignore next 6 */
            if (!maybeTokenState) {
                throw new SDTFError('SDTF_INTERNAL_DESIGN_ERROR', `Token not found for path: ${analyzedToken.path}`);
            }
            tokenState = maybeTokenState;
        }
        // We populate the alias references
        fillAliasReferences(analyzedToken, tokenState, aliasReferences, stringPath => findOrRegisterTokenState(stringPath, globalTokensState, analyzedTokens, treeState));
    });
}
